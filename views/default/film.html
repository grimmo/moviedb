{{extend 'layout.html'}}
<div class="page-header">
<ul class="nav nav-tabs" id="miomenu">
<li class="active"><a href="#home" data-toggle="tab">Home</a></li>
<li><a href="#cast" data-toggle="tab">Cast</a></li>
<li><a href="#media" data-toggle="tab" id="mediatab">Media</a></li>
<!-- <li><a href="#settings" data-toggle="tab">Settings</a></li> -->
</ul>
</div>
{{ if session.brandnew: }}
	<div class="alert alert-success">
	<button type="button" class="close" data-dismiss="alert">&times;</button>
	<dl class="dl-horizontal">                
        <dt>Movie import</dt><dd><i class="icon-ok"></i></dd>
        {{ if session.poster_fetched: }}
        <dt>Poster import</dt><dd><i class="icon-ok"></i></dd>
        {{ else: }}
        <dt>Poster fail</dt><dd><i class="icon-remove icon-red"></i></dd>
        {{ pass }}
        {{ if session.cast_fetched: }}
        <dt>Cast &amp; crew import</dt><dd><i class="icon-ok"></i></dd>
        {{ else: }}
        <dt>Cast &amp; crew fail</dt><dd><i class="icon-remove icon-red"></i></dd>
        {{ pass }}
    </dl>
	</div>
{{ pass }}
{{ if session.errors: }}
<div class="alert alert-block">    
	<button type="button" class="close" data-dismiss="alert">&times;</button>
    <h4>Errors reported during update</h4>
    <p id="error_message"></p>    
</div>
{{ pass }}
<h1 class="text-center">{{ = film.titolo }} 
    	{{ if film.anno <> 0: }}
			({{= film.anno }})
    	{{ pass }}    
    </h1>
    <h4>
    <p class="muted">
    di&nbsp;
    {{ for persona in cast.find(lambda row: row.ruoli.regista==True): }}    
        {{ = A(persona.moviecast.nome,_href=URL('default','persona',args=persona.moviecast.slug)) }}
    {{ pass }}
    </p>
    </h4>    
<div class="tab-content">
	<div class="tab-pane active" id="home">	
   	<div class="pull-right btn-group btn-group-vertical">
    	<ul class="unstyled">
    		<li><a class="btn" href="#" onclick="window.location='{{=URL('default','edit',args=film.id)}}'"><i class="icon-edit icon-2x"></i></a></li>
    		{{ if film.visto: }}
            <li><a class="btn btn-success" href="#"><i class="icon-ticket icon-2x" title="Hai già visto questo film"></i></a></li>
    		{{ pass }}			
    		{{ if film.masterizzato(): }}
            <li><a class="btn" onclick="$('#mediatab').click();"><i class="icon-save icon-2x" title="Questo film è associato a uno o più supporti"></i></a></li>
            
            
    		{{ pass }}        	
        	{{ if film.tmdb_id: }}    
			<li><a class="btn" href="#" onclick="aggiorna_film()" id="tmdbupdate_btn"><i id="tmdbupdate_spinner" class="icon-refresh icon-2x"></i></a>
			{{ else: }}
			<li><a class="btn" href="#openModal" onclick="aggiorna_film()" id="tmdbupdate_btn"><i id="tmdbupdate_spinner" class="icon-refresh icon-2x"></i></a>
			{{ pass }}             
             
        </ul>
    </div>        
	<span class="span4">
	<img src="{{ = URL('default','download',args=film.locandina) }}" class="img img-rounded pull-left">    	
	<p>{{ = film.trama }}</p>		
    <dl class="horizontal">
    <dt>Giudizio:</dt><dd>{{ = film.giudizio_mio }}</dd>
	</dl>
        <strong>{{=T('Tag')}}</strong>
        <dl class="dl-horizontal">                    
        {{ for tag in film.tags(): }}
            <dt>{{ = A(tag.nome,_class="btn btn-info",_href=URL('moviedb','default','tags',args=tag.slug)) }}</dt>
        {{ pass }}
        </dl>
        </span>   
</div>
<div class="tab-pane" id="cast">
    <h5>Cast for this movie</h5>
<dt>
{{ for persona in cast.find(lambda row: row.ruoli.regista==False): }}    
    <dd>{{ = A(persona.moviecast.nome,_href=URL('default','persona',args=persona.moviecast.slug)) }}</dd>     
{{ pass }}
</dt>
</div>
<div class="tab-pane" id="media">	
    <h5>Media&nbsp;{{ = A(I(_class="icon-plus"),_href=URL('associamedia',vars=dict(film= film.id)),_class="btn btn-primary") }}</h5>
	{{ if media: }}
	{{ for supporto in media: }}
		{{ = db.supporto[supporto.supporto].tipo.nome }} n.&nbsp;
			{{ if db.supporto[supporto.supporto].id_originale: }}
				{{ =A(db.supporto[supporto.supporto].id_originale,_href=URL('default','supporto',args=db.supporto[supporto.supporto].id)) }}
			{{ else: }}
				{{ =A(db.supporto[supporto.supporto].id,_href=URL('default','supporto',args=db.supporto[supporto.supporto].id)) }}
			{{ pass }}
	&nbsp;({{ =supporto.tipo }})
	{{ pass }}		
{{ pass }}
</div>
</div>

<div id="openModal" class="modalDialog">
<div>
<a href="#close" title="Close" class="close">X</a>
<h2>Seleziona il film corrispondente</h2>
<dt>
<span class="TitoliTrovati"></span>
</dt>
   	</div>
</div>
{{ if film.tmdb_id: }}
<script>
    // Funzione di aggiornamento diretto con id di themoviedb.org
    function aggiorna_film() {        
        $("#tmdbupdate_spinner").addClass("icon-refresh icon-spin");
        $("#tmdbupdate_btn").attr('disabled','disabled');
        //$("#tmdbupdate_btn").text('attendere...')
        //return ajax('/moviedb/tmdb/update_movie_by_id?tmdb_id={{ = film.tmdb_id }}',[],':eval');
        return ajax('/moviedb/default/update_movie?existing_id={{=film.id}}&tmdb_id={{ =film.tmdb_id }}',[],':eval');
    }
</script>
{{ else: }}
<script>
    // Funzione di aggiornamento indiretto, e' necessario prima trovare l'id del film corretto
    // su themoviedb.org
    function aggiorna_film() {    	 
        //$("#tmdbupdate_spinner").addClass("icon-refresh icon-spin"); 
        //$("#tmdbupdate_btn").attr('disabled','disabled');
        //$("#tmdbupdate_btn").text('attendere...');	
    	window.location.hash = '#'+'openModal';
        $.getJSON('/moviedb/tmdb/call/json/find_title?movie_id={{ =film.id }}', function(data) {
			var titolitrovati = '';
			$.each(data, function(results) {
                var ajax_url = "{{ = URL('default','update_movie')}}" + '?existing_id={{=film.id}}&tmdb_id=' + data[results].id;
                //'/moviedb/tmdb/get_movie_details?tmdb_id='+data[results].id;
                titolitrovati = titolitrovati+'<dd><a href="#" onclick="ajax(\'' + ajax_url +'\',[],\':eval\')"><strong>'+data[results].title+'</strong></a>&nbsp;('+data[results].release_date+')</dd>';
			});
			$('.TitoliTrovati').html(titolitrovati);
		});
};
</script>
{{ pass }}
